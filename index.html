<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font-weight 700/800 agar bold terlihat jelas */
        body { font-family: 'Inter', sans-serif; }
        #app { min-height: 100vh; display: flex; flex-direction: column; }
        
        /* PENTING: Padding bawah disesuaikan agar konten tidak tertutup bottom bar */
        #mainContent { 
            flex-grow: 1; 
            overflow-y: hidden; 
            padding-bottom: 6rem; /* 96px */
        } 

        #cartList { max-height: 400px; overflow-y: auto; }
        @media (min-width: 768px) { #cartList { max-height: 600px; } }

        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            @apply hover:scale-[1.02] hover:shadow-xl;
        }
        .input-rupiah { text-align: right; }
        .receipt-print-area { font-family: 'Courier New', monospace; font-size: 10px; width: 200px; margin: 0 auto; padding: 5px; line-height: 1.1; }
        
        /* * MODIFIKASI UTAMA UNTUK BOTTOM BAR MODERN * */
        .tab-button-modern {
            @apply flex flex-col items-center justify-center p-2 text-gray-500 transition-all duration-300 ease-in-out flex-grow h-full relative; 
            border-radius: 12px; 
            margin: 0; 
            min-width: 60px;
        }
        
        /* MODIFIKASI UNTUK PILL SHAPE BACKGROUND */
        .tab-button-modern.active .tab-content {
            /* Warna latar belakang tombol aktif (Pill-shaped background) menjadi indigo-700 */
            @apply bg-indigo-700 text-white shadow-xl scale-105; 
            transform: scale(1.05);
        }

        .tab-button-modern:not(.active):hover .tab-content {
             @apply bg-indigo-100 text-indigo-700 shadow-md;
             transform: scale(0.95); 
        }

        .tab-content {
            /* Wadah untuk icon dan label agar bisa menjadi bentuk kapsul */
            @apply flex items-center justify-center p-2 md:px-4 md:py-3 rounded-full transition-all duration-300 ease-in-out w-full;
            max-width: 120px; 
        }
        
        .tab-icon {
            @apply text-xl md:text-2xl;
        }
        
        /* BARU: Memastikan ikon aktif berwarna putih untuk kontras */
        .tab-button-modern.active .tab-icon {
            @apply text-white; 
        }

        /* * SOLUSI AKHIR DAN PAKSA TEBAL DENGAN PRIORITAS TERTINGGI * */
        .tab-label {
            /* STANDAR (NON-AKTIF): font-semibold (600), sembunyikan di mobile, tampil di md */
            @apply ml-2 text-sm font-semibold text-gray-700 transition-all duration-300 hidden md:inline; 
        }

        /* PERBAIKAN FONT TEBAL AKTIF: PAKSA TEBAL DENGAN PANGGILAN CSS MURNI DAN PRIORITAS TERTINGGI */
        .tab-button-modern.active .tab-label {
            /* Properti yang PASTI DIBUTUHKAN (Warna) */
            @apply text-white; 
            
            /* KUNCI PERBAIKAN FONT TEBAL */
            font-weight: 700 !important; /* Nilai 700 adalah 'bold' */
            
            /* KUNCI PERBAIKAN VISIBILITY: Paksa tampil di mobile saat aktif */
            display: inline !important; 
        }
        
        /* * MODIFIKASI BARU: GAUSSIAN BLUR & OPACITY * */
        .floating-nav-blur {
            /* Gaussian Blur */
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            /* Border dan Shadow tetap dipertahankan */
            @apply border border-indigo-200 shadow-2xl; 
        }
        
        /* BARU: Efek Blur untuk Backdrop Modal, menggunakan nilai blur yang sama */
        .modal-backdrop-blur {
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app">
        
        <div id="mainContent" class="overflow-y-auto">
            <div id="posView" class="h-full flex flex-col md:flex-row p-2 sm:p-4 bg-gray-50">
                <div class="w-full md:w-3/5 p-2 sm:p-4 flex flex-col bg-white shadow-lg rounded-xl overflow-hidden mb-4 md:mb-0 md:h-full flex-shrink-0">
                    <header class="mb-4 flex justify-between items-center border-b pb-3">
                        <h1 class="text-xl font-bold text-indigo-600">Daftar Menu / Produk</h1>
                        <button onclick="showProductModal()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg shadow-md transition duration-150 text-sm sm:text-base">
                            + Tambah Produk
                        </button>
                    </header>

                    <div class="mb-4">
                        <input type="text" id="productSearch" oninput="renderProducts()" placeholder="Cari produk..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div id="productList" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 flex-grow overflow-y-auto">
                        </div>
                </div>

                <div class="w-full md:w-2/5 md:pl-4 flex flex-col bg-gray-100 flex-shrink-0">
                    <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col h-full overflow-y-auto">
                        <h2 class="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">Keranjang Belanja</h2>

                        <div id="cartList" class="space-y-3 mb-4 flex-grow p-3 rounded-lg shadow-inner border overflow-y-auto">
                            <p id="emptyCartMessage" class="text-gray-500 text-center py-4">Keranjang kosong. Silakan pilih produk.</p>
                            </div>

                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner space-y-2 mb-4">
                            <div class="flex justify-between font-medium">
                                <span>Subtotal :</span>
                                <span id="subtotal">Rp0</span>
                            </div>
                            <div class="flex justify-between font-medium text-sm text-gray-600 border-t pt-2">
                                <span>DPP (Dasar Pengenaan Pajak):</span>
                                <span id="dppAmount">Rp0</span>
                            </div>
                            <div class="flex justify-between font-medium text-sm text-gray-600">
                                <span>Pajak (<span id="taxRateDisplay">0</span>% PPN):</span>
                                <span id="taxAmount">Rp0</span>
                            </div>
                            <div class="flex justify-between items-center border-t pt-2">
                                <span>Diskon (%):</span>
                                <input type="number" id="discountPercent" value="0" min="0" max="100" oninput="updateTotals()" class="w-16 p-1 border rounded text-right">
                            </div>
                            <div class="flex justify-between text-xl font-bold pt-2 border-t">
                                <span>TOTAL :</span>
                                <span id="totalAmount" class="text-indigo-600">Rp0</span>
                            </div>
                        </div>

                        <div class="space-y-3 pb-2">
                            <h3 class="font-semibold text-gray-700">Pembayaran</h3>
                            <input type="number" id="paymentAmount" oninput="calculateChange()" placeholder="Jumlah Uang Dibayar" class="w-full p-3 border border-gray-300 rounded-lg input-rupiah focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="flex justify-between font-bold text-xl">
                                <span>Kembalian:</span>
                                <span id="changeAmount" class="text-green-600">Rp0</span>
                            </div>
                            <button onclick="processTransaction()" id="checkoutButton" disabled class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg transition duration-150 disabled:bg-indigo-300 shadow-xl">
                                Proses Transaksi
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyView" class="p-4 sm:p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700">Riwayat Transaksi</h2>
                <div class="mb-6 p-4 border rounded-lg bg-white shadow">
                    <h3 class="font-semibold mb-3">Filter Transaksi</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="historySearch" oninput="renderHistoryView()" placeholder="Cari ID Transaksi/Nama Produk..." class="p-2 border border-gray-300 rounded-lg col-span-full md:col-span-1">
                        <input type="date" id="startDateFilter" onchange="renderHistoryView()" class="p-2 border border-gray-300 rounded-lg">
                        <input type="date" id="endDateFilter" onchange="renderHistoryView()" class="p-2 border border-gray-300 rounded-lg">
                        <button onclick="clearHistoryFilters()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">Reset Filter</button>
                    </div>
                </div>
                <div id="historyList" class="space-y-4">
                    <p class="text-center text-gray-500" id="loadingHistory">Memuat riwayat...</p>
                    </div>
            </div>

            <div id="settingsView" class="p-4 sm:p-6 hidden bg-white shadow-xl rounded-xl m-2 sm:m-4 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b pb-2">Pengaturan Aplikasi</h2>

                <div class="mb-8 border p-6 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">1. Konfigurasi Struk & Pajak</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="cashierNameInput" class="block text-sm font-medium text-gray-700">Nama Kasir (Dicetak di Struk)</label>
                            <input type="text" id="cashierNameInput" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Contoh: Budi, atau biarkan kosong">
                        </div>
                        <div>
                            <label for="taxPercentInput" class="block text-sm font-medium text-gray-700">Persentase Pajak Inklusif (%)</label>
                            <input type="number" id="taxPercentInput" min="0" max="100" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Contoh: 11">
                        </div>
                        <div>
                            <label for="receiptHeader" class="block text-sm font-medium text-gray-700">Teks Header Struk (Maks 3 baris)</label>
                            <textarea id="receiptHeader" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Contoh:&#10;WARUNG MAKAN SEDERHANA&#10;Jl. Kenanga No. 12&#10;Telp: 0812-XXXX-XXXX"></textarea>
                        </div>
                        <div>
                            <label for="receiptFooter" class="block text-sm font-medium text-gray-700">Teks Footer Struk (Pesan Penutup)</label>
                            <textarea id="receiptFooter" rows="2" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Contoh:&#10;Terima kasih atas kunjungan Anda!&#10;Barang yang sudah dibeli tidak dapat ditukar/dikembalikan."></textarea>
                        </div>
                        <button onclick="saveSettings()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">Simpan Konfigurasi</button>
                    </div>
                </div>

                <div class="mb-8 border p-6 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">2. Sinkronisasi Data Dropbox (Manual)</h3>
                    <p class="text-gray-600 mb-4 text-sm">Gunakan fitur ini untuk memuat data dari (Baca) atau mengunduh data (Tulis) melalui Shared Link Dropbox. Link yang Anda simpan akan **otomatis dikonversi** ke format unduhan langsung (`dl.dropboxusercontent.com`) saat disimpan.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="dropboxSyncLink" class="block text-sm font-medium text-gray-700">Shared Link Dropbox</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="url" id="dropboxSyncLink" class="block w-full p-3 border border-gray-300 rounded-lg" placeholder="Contoh: https://www.dropbox.com/scl/fi/..../pos_sync_data.json?dl=0">
                                <button onclick="saveSyncLink()" class="bg-indigo-400 hover:bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 flex-shrink-0">Simpan Link</button>
                            </div>
                        </div>
                        
                        <button id="syncFromDropboxButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                            Sinkronisasi Data (Baca/Muat Terbaru)
                        </button>
                        
                        <button id="downloadDataButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                            Unduh Data Backup (Untuk Upload Manual)
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Setelah mengunduh, Anda harus mengunggah file **pos_sync_data.json** ini secara manual ke Shared Folder Dropbox Anda.</p>
                    </div>
                </div>

                <div class="mb-8 border p-6 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">3. Konsolidasi Data Transaksi (Multi-Cabang)</h3>
                    <p class="text-gray-600 mb-4 text-sm">Gunakan fitur ini untuk mengirim atau menggabungkan riwayat transaksi antar cabang secara terpisah.</p>
                    
                    <div class="space-y-4 mb-6">
                        <label for="transactionSyncLink" class="block text-sm font-medium text-gray-700">Daftar Shared Link Dropbox Riwayat Transaksi (Per Cabang)</label>
                        <div class="flex space-x-2 mt-1">
                            <textarea id="transactionSyncLink" rows="4" class="block w-full p-3 border border-gray-300 rounded-lg" placeholder="Masukkan satu link per baris. Contoh:&#10;https://www.dropbox.com/scl/fi/..../cabang_a.json?dl=0&#10;https://www.dropbox.com/scl/fi/..../cabang_b.json?dl=0"></textarea>
                            <button onclick="saveTransactionSyncLink()" class="bg-purple-400 hover:bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 flex-shrink-0">Simpan Link</button>
                        </div>
                        <p class="text-xs text-gray-500">Link akan dikonversi otomatis ke format unduhan langsung setelah disimpan. Pastikan setiap link berada pada baris baru.</p>
                    </div>

                    <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <button onclick="exportTransactionsOnly()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                                üì• Ekspor Riwayat Transaksi Saja
                            </button>
                            <p class="text-sm text-gray-600 mt-2">Unduh semua riwayat transaksi ke file JSON (untuk diunggah ke Shared Link).</p>
                        </div>
                        <div class="flex-1">
                            <button onclick="syncTransactionFromDropbox()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg shadow-md cursor-pointer transition duration-150">
                                üîÑ Gabungkan Riwayat dari Link
                            </button>
                            <p class="text-sm text-gray-600 mt-2">Gabungkan transaksi dan log aktivitas dari file JSON yang di-link. Proses ini membutuhkan **otentikasi PIN**.</p>
                        </div>
                    </div>
                </div>
                <div class="mb-8 border p-6 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">4. Ekspor & Impor Data Lokal</h3>
                    <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <button onclick="exportData()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                                Ekspor Semua Data (JSON)
                            </button>
                            <p class="text-sm text-gray-600 mt-2">Unduh Produk, Transaksi, dan Pengaturan.</p>
                        </div>
                        <div class="flex-1">
                            <label for="importFile" class="block w-full text-center bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 rounded-lg shadow-md cursor-pointer transition duration-150">
                                Impor Data dari JSON
                            </label>
                            <input type="file" id="importFile" accept="application/json" class="hidden" onchange="importData(event)">
                            <p class="text-sm text-gray-600 mt-2">Peringatan: Ini akan menimpa data yang ada.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8 border p-6 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">5. Log Seluruh Kegiatan User</h3>
                    <p class="text-gray-600 mb-4">Catatan semua aktivitas (transaksi, manajemen produk, pengaturan) disimpan secara lokal dan dapat diunduh untuk audit.</p>
                    <div class="mt-4 flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                        <button onclick="exportActivityLogs()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                            Unduh Log Aktivitas (JSON)
                        </button>
                        <button onclick="showClearLogsConfirm()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                            Hapus Semua Log
                        </button>
                    </div>
                </div>
            </div>

        </div>
        
        <nav class="fixed bottom-4 left-4 right-4 bg-indigo-50 bg-opacity-60 floating-nav-blur z-40 h-16 rounded-full max-w-lg mx-auto md:h-20"> 
            <div class="flex justify-around p-1 h-full">
                <button class="tab-button-modern tab-button active"
                        onclick="switchTab('posView')" data-tab="posView">
                    <span class="tab-content">
                        <span class="tab-icon">üè†</span>
                        <span class="tab-label">Utama</span>
                    </span>
                </button>
                <button class="tab-button-modern tab-button"
                        onclick="switchTab('historyView')" data-tab="historyView">
                    <span class="tab-content">
                        <span class="tab-icon">üìú</span>
                        <span class="tab-label">Riwayat</span>
                    </span>
                </button>
                <button class="tab-button-modern tab-button"
                        onclick="switchTab('settingsView')" data-tab="settingsView">
                    <span class="tab-content">
                        <span class="tab-icon">‚öôÔ∏è</span>
                        <span class="tab-label">Pengaturan</span>
                    </span>
                </button>
            </div>
        </nav>
        </div>

    <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-3 text-red-600" id="messageTitle">Peringatan!</h3>
            <p id="messageText" class="text-gray-700 mb-5"></p>
            <button onclick="hideMessageModal()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg">Tutup</button>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-3 text-orange-600" id="confirmTitle">Konfirmasi!</h3>
            <p id="confirmText" class="text-gray-700 mb-5"></p>
            <div class="flex space-x-4">
                <button id="confirmYesButton" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg">Ya, Lanjutkan</button>
                <button id="confirmNoButton" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">Batal</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-indigo-700" id="productModalTitle">Tambah Produk Baru</h3>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="mb-4">
                    <label for="productName" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                    <input type="text" id="productName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="productPrice" class="block text-sm font-medium text-gray-700">Harga (Rp)</label>
                    <input type="number" id="productPrice" min="100" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg input-rupiah">
                </div>
                <div class="mb-6">
                    <label for="productStock" class="block text-sm font-medium text-gray-700">Stok Awal</label>
                    <input type="number" id="productStock" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg input-rupiah">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" id="productSaveButton" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">Simpan Produk</button>
                    <button type="button" onclick="hideProductModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg">Batal</button>
                </div>
                <button type="button" id="productDeleteButton" onclick="deleteProduct()" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150 hidden">Hapus Produk</button>
            </form>
        </div>
    </div>
    
    <div id="receiptModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-indigo-700 text-center">Pratinjau Struk</h3>
            <div id="receiptPrintArea" class="border border-gray-300 p-4 bg-white overflow-y-auto max-h-[70vh]">
                </div>
            <div class="flex space-x-4 mt-6">
                <button onclick="printReceipt()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150">
                    Cetak Struk
                </button>
                <button onclick="hideReceiptModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg">Tutup</button>
            </div>
        </div>
    </div>
    
    <div id="syncConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-3 text-indigo-700">‚úÖ File Backup Berhasil Diunduh!</h3>
            <p class="text-gray-700 mb-2">File telah berhasil diunduh dari Dropbox dan siap untuk menimpa data lokal Anda.</p>
            <p class="text-sm font-semibold text-orange-600 mb-4">Waktu File Backup: <span id="syncConfirmTimestamp">Memuat...</span></p>
            <p class="text-sm text-red-600 mb-5 font-bold">PERINGATAN: Menekan tombol di bawah akan **MENGHAPUS DAN MENIMPA** semua data lokal Anda dengan data dari file ini.</p>
            <div class="flex space-x-4">
                <button id="syncConfirmButton" onclick="performCloudImport(this.dataset.importedData)" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg">
                    Ya, Sinkronkan Sekarang
                </button>
                <button onclick="document.getElementById('syncConfirmModal').classList.remove('flex'); document.getElementById('syncConfirmModal').classList.add('hidden');" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">
                    Batal
                </button>
            </div>
        </div>
    </div>
    <div id="pinModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50 modal-backdrop-blur">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-3 text-indigo-700" id="pinTitle">Masukkan PIN</h3>
            <p id="pinText" class="text-gray-700 mb-4">Harap masukkan PIN:</p>
            <input type="password" inputmode="numeric" id="pinInput" maxlength="4" class="w-full p-3 mb-5 border border-gray-300 rounded-lg text-center text-xl font-mono tracking-widest focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="flex space-x-4">
                <button id="pinSubmitButton" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg">Konfirmasi</button>
                <button id="pinCancelButton" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">Batal</button>
            </div>
        </div>
    </div>
    <script>
        // --- 1. Konfigurasi dan Variabel Global ---
        const DB_NAME = 'POSAppDB';
        const DB_VERSION = 3; 
        const STORE_PRODUCTS = 'products';
        const STORE_TRANSACTIONS = 'transactions';
        const STORE_SETTINGS = 'settings'; 
        const STORE_ACTIVITY_LOGS = 'activityLogs'; 
        const DB_LINK_STORAGE_KEY = 'pos_dropbox_sync_link'; // Kunci untuk sinkronisasi data penuh
        const TRANSACTION_LINK_STORAGE_KEY = 'pos_dropbox_transaction_link'; // Kunci baru untuk sinkronisasi transaksi saja
        
        let db; 
        let resolveConfirm; 
        let resolvePin; 
        
        const pastelColors = [
            { bg: 'bg-teal-100', text: 'text-teal-900' },
            { bg: 'bg-rose-100', text: 'text-rose-900' },
            { bg: 'bg-blue-100', text: 'text-blue-900' },
            { bg: 'bg-lime-100', text: 'text-lime-900' },
            { bg: 'bg-indigo-100', text: 'text-indigo-900' },
            { bg: 'bg-amber-100', text: 'text-amber-900' },
        ];
        
        let state = {
            products: [],
            cart: [], // { id, name, price, quantity }
            total: 0,
            subtotal: 0,
            discountPercent: 0,
            taxPercent: 11, // Default 11% PPN
            dpp: 0, // Dasar Pengenaan Pajak
            tax: 0, // Jumlah Pajak (PPN)
            change: 0,
            settings: {
                receiptHeader: "TOKO SEDERHANA\nJl. Raya No. 1",
                receiptFooter: "Terima kasih!",
                taxPercent: 11, // Default 11% PPN
                cashierName: '' // Fitur Baru: Nama Kasir
            },
            currentView: 'posView'
        };

        const initialProducts = [
            { id: 1, name: 'Nasi Goreng Spesial', price: 25000, stock: 50 },
            { id: 2, name: 'Es Teh Manis', price: 5000, stock: 100 },
            { id: 3, name: 'Sate Ayam 10 Tusuk', price: 30000, stock: 30 },
            { id: 4, name: 'Ayam Geprek', price: 20000, stock: 45 },
            { id: 5, name: 'Jus Alpukat', price: 15000, stock: 60 },
            { id: 6, name: 'Mie Ayam Bakso', price: 22000, stock: 40 },
        ];

        // --- 2. Utilitas ---
        function formatRupiah(number) {
            if (typeof number !== 'number' || isNaN(number)) return 'Rp 0';
            const roundedNumber = Math.round(number);
            
            const formatter = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            const formattedNumber = formatter.format(roundedNumber);
            
            return 'Rp ' + formattedNumber; 
        }
        function showMessageModal(title, message, colorClass = 'text-red-600') {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageTitle').className = `text-xl font-bold mb-3 ${colorClass}`;
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.remove('flex');
            document.getElementById('messageModal').classList.add('hidden');
        }
        function showConfirmModal(title, message) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');

            return new Promise(resolve => {
                resolveConfirm = resolve;
            });
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('flex');
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function setupConfirmListeners() {
            document.getElementById('confirmYesButton').onclick = () => {
                hideConfirmModal();
                if (resolveConfirm) resolveConfirm(true);
            };
            document.getElementById('confirmNoButton').onclick = () => {
                hideConfirmModal();
                if (resolveConfirm) resolveConfirm(false);
            };
        }
        function showPinModal(title, message) {
            document.getElementById('pinTitle').textContent = title;
            document.getElementById('pinText').textContent = message;
            const pinInput = document.getElementById('pinInput');
            pinInput.value = ''; // Bersihkan input
            pinInput.focus(); // Fokus ke input
            document.getElementById('pinModal').classList.remove('hidden');
            document.getElementById('pinModal').classList.add('flex');

            return new Promise(resolve => {
                resolvePin = resolve;
            });
        }
        
        function hidePinModal() {
            document.getElementById('pinModal').classList.remove('flex');
            document.getElementById('pinModal').classList.add('hidden');
        }
        
        function setupPinModalListeners() {
            const pinInput = document.getElementById('pinInput');
            
            document.getElementById('pinSubmitButton').onclick = () => {
                const pin = pinInput.value.trim();
                hidePinModal();
                if (resolvePin) resolvePin(pin);
            };
            
            document.getElementById('pinCancelButton').onclick = () => {
                hidePinModal();
                if (resolvePin) resolvePin(null); 
            };
            
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('pinSubmitButton').click();
                }
            });
            
             pinInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
             });
        }
        async function logActivity(type, description) { 
            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: type,
                description: description,
                cashier: state.settings.cashierName || 'N/A' 
            };
            try {
                await putItem(STORE_ACTIVITY_LOGS, logEntry);
            } catch (error) {
                console.error('Failed to log activity:', error);
            }
        }
        
        // --- 3. Logic Tab View (Diperbarui untuk Bottom Bar) ---
        function switchTab(tabName) {
            state.currentView = tabName;
            
            // Sembunyikan semua view
            document.getElementById('posView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');

            // Hapus style aktif dari semua tombol (menggunakan class .tab-button-modern)
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active'); 
            });

            // Tampilkan view yang dipilih
            const activeView = document.getElementById(tabName);
            const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            
            if (activeView) activeView.classList.remove('hidden');
            
            // Tambahkan style aktif ke tombol yang dipilih
            if (activeTabButton) {
                activeTabButton.classList.add('active'); 
            }
            
            // Panggil render/load spesifik untuk tab
            if (tabName === 'historyView') {
                renderHistoryView();
            } else if (tabName === 'settingsView') {
                loadSettingsToForm();
                loadSyncLink(); // Muat link data penuh
                loadTransactionSyncLink(); // Muat link transaksi
            }
        }

        // --- 4. IndexedDB Core Logic ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_PRODUCTS)) {
                        db.createObjectStore(STORE_PRODUCTS, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_TRANSACTIONS)) {
                        db.createObjectStore(STORE_TRANSACTIONS, { keyPath: 'id' }); // Tetap tanpa autoIncrement agar ID transaksi (timestamp) unik
                    }
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains(STORE_ACTIVITY_LOGS)) { 
                        db.createObjectStore(STORE_ACTIVITY_LOGS, { keyPath: 'id' }); // ID Log juga harus unik (timestamp)
                    }
                    console.log('Database setup complete.');
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    showMessageModal('Kesalahan Database', 'Gagal membuka database: ' + event.target.error.name);
                    reject(event.target.error);
                };
            });
        }
        function getAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        function getOne(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        function putItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(item);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        function deleteItem(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function clearAllData() {
            await clearStore(STORE_PRODUCTS);
            await clearStore(STORE_TRANSACTIONS);
            await clearStore(STORE_SETTINGS);
            await clearStore(STORE_ACTIVITY_LOGS);
        }


        // --- 5. Logic Aplikasi (Produk & Keranjang) ---

        async function loadProducts() {
            try {
                const loadedProducts = await getAll(STORE_PRODUCTS);
                if (loadedProducts.length === 0) {
                    for (const product of initialProducts) {
                        await putItem(STORE_PRODUCTS, product);
                    }
                    state.products = initialProducts;
                } else {
                    state.products = loadedProducts;
                }
                renderProducts();
            } catch (error) {
                console.error('Failed to load products:', error);
                showMessageModal('Gagal Memuat Produk', 'Gagal memuat data produk dari database.');
            }
        }
        
        async function loadSettings() {
            try {
                const config = await getOne(STORE_SETTINGS, 'receiptConfig');
                if (config && config.value) {
                    state.settings = { ...state.settings, ...config.value };
                    state.taxPercent = state.settings.taxPercent;
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            container.innerHTML = '';

            const filteredProducts = state.products.filter(p =>
                p.name.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">Tidak ada produk ditemukan.</p>`;
                return;
            }

            filteredProducts.forEach(product => {
                const colorIndex = product.id % pastelColors.length;
                const color = pastelColors[colorIndex];

                const card = document.createElement('div');
                card.className = `product-card ${color.bg} p-4 rounded-xl shadow-lg cursor-pointer ${product.stock === 0 ? 'opacity-50 grayscale' : ''}`;
                card.onclick = () => product.stock > 0 ? addToCart(product) : showMessageModal('Stok Habis', `${product.name} saat ini sedang habis.`);

                card.innerHTML = `
                    <h3 class="text-md font-semibold truncate ${color.text}">${product.name}</h3>
                    <p class="text-lg font-bold my-1 ${color.text}">${formatRupiah(product.price)}</p>
                    <p class="text-sm ${color.text}">Stok: 
                        <span class="${product.stock > 10 ? 'text-green-700' : product.stock > 0 ? 'text-orange-700' : 'text-red-700'} font-medium">
                            ${product.stock}
                        </span>
                    </p>
                    <button onclick="event.stopPropagation(); editProduct(${product.id})" class="mt-2 text-xs text-blue-700 hover:text-blue-900">Edit</button>
                `;
                container.appendChild(card);
            });
        }

        function addToCart(product) {
            const existingItem = state.cart.find(item => item.id === product.id);

            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    showMessageModal('Stok Maksimal', `Kuantitas ${product.name} sudah mencapai batas stok (${product.stock}).`);
                    return;
                }
            } else {
                state.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    stock: product.stock 
                });
            }

            renderCart();
            updateTotals();
        }

        function updateCartQuantity(productId, quantity) {
            const itemIndex = state.cart.findIndex(item => item.id === productId);

            if (itemIndex !== -1) {
                const productInState = state.products.find(p => p.id === productId);
                const currentStock = productInState ? productInState.stock : 0;
                let newQuantity = parseInt(quantity);
                
                if (isNaN(newQuantity) || newQuantity < 0) newQuantity = 0;

                if (newQuantity > 0 && newQuantity <= currentStock) {
                    state.cart[itemIndex].quantity = newQuantity;
                } else if (newQuantity > currentStock) {
                    showMessageModal('Stok Maksimal', `Kuantitas melebihi stok yang tersedia (${currentStock}).`);
                    state.cart[itemIndex].quantity = currentStock; 
                } else {
                    state.cart.splice(itemIndex, 1);
                }
            }
            renderCart();
            updateTotals();
        }

        function renderCart() {
            const container = document.getElementById('cartList');
            container.innerHTML = '';

            const emptyMessage = document.getElementById('emptyCartMessage'); 

            if (state.cart.length === 0) {
                if (emptyMessage) emptyMessage.style.display = 'block'; 
                return;
            }
            if (emptyMessage) emptyMessage.style.display = 'none'; 

            state.cart.forEach(item => {
                const totalItem = item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center justify-between p-2 border-b last:border-b-0 bg-gray-50 rounded-md';
                cartItem.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <p class="font-medium text-gray-700 truncate">${item.name}</p>
                        <p class="text-sm text-gray-500">${formatRupiah(item.price)} x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex border rounded-lg overflow-hidden flex-shrink-0">
                            <button onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})" class="px-2 py-1 text-sm bg-red-100 hover:bg-red-200">-</button>
                            <input type="number" value="${item.quantity}" min="1" max="${item.stock}" onchange="updateCartQuantity(${item.id}, parseInt(this.value))" class="w-10 text-center text-sm border-x p-1">
                            <button onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})" class="px-2 py-1 text-sm bg-green-100 hover:bg-green-200">+</button>
                        </div>
                        <span class="font-semibold text-right w-20 sm:w-24 flex-shrink-0">${formatRupiah(totalItem)}</span>
                    </div>
                `;
                container.appendChild(cartItem);
            });
        }

        function updateTotals() {
            state.taxPercent = state.settings.taxPercent || 0; 
            state.subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            state.discountPercent = parseInt(document.getElementById('discountPercent').value) || 0;
            const subtotalAfterDiscount = state.subtotal * (1 - (state.discountPercent / 100));
            
            const taxFactor = 1 + (state.taxPercent / 100);
            const dppAmount = subtotalAfterDiscount / taxFactor;
            const taxAmount = subtotalAfterDiscount - dppAmount;
            
            state.total = Math.round(subtotalAfterDiscount); 
            state.dpp = Math.round(dppAmount);
            state.tax = Math.round(taxAmount);

            document.getElementById('subtotal').textContent = formatRupiah(state.subtotal);
            document.getElementById('dppAmount').textContent = formatRupiah(state.dpp);
            document.getElementById('taxAmount').textContent = formatRupiah(state.tax);
            document.getElementById('taxRateDisplay').textContent = state.taxPercent;
            document.getElementById('totalAmount').textContent = formatRupiah(state.total);

            calculateChange();
        }

        function calculateChange() {
            const payment = parseInt(document.getElementById('paymentAmount').value) || 0;
            state.change = payment - state.total;

            document.getElementById('changeAmount').textContent = formatRupiah(state.change);

            const checkoutButton = document.getElementById('checkoutButton');
            checkoutButton.disabled = state.cart.length === 0 || state.change < 0;

            if (state.change < 0) {
                document.getElementById('changeAmount').classList.remove('text-green-600');
                document.getElementById('changeAmount').classList.add('text-red-600');
            } else {
                document.getElementById('changeAmount').classList.remove('text-red-600');
                document.getElementById('changeAmount').classList.add('text-green-600');
            }
        }

        // --- 6. Logic Transaksi dan Checkout ---

        async function processTransaction() {
            if (state.cart.length === 0) {
                showMessageModal('Keranjang Kosong', 'Tidak ada item di keranjang.', 'text-orange-500');
                return;
            }

            if (state.change < 0) {
                showMessageModal('Pembayaran Kurang', 'Jumlah uang yang dibayarkan kurang dari total belanja.', 'text-red-600');
                return;
            }

            try {
                const transaction = {
                    id: Date.now(), 
                    timestamp: new Date().toISOString(),
                    items: state.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                    })),
                    subtotal: state.subtotal,
                    discountPercent: state.discountPercent,
                    dpp: state.dpp,
                    tax: state.tax,
                    taxPercent: state.taxPercent,
                    total: state.total,
                    payment: parseInt(document.getElementById('paymentAmount').value) || 0,
                    change: state.change
                };

                await putItem(STORE_TRANSACTIONS, transaction);
                await logActivity('TRANSACTION_SALE', `Transaksi berhasil, Total: ${formatRupiah(transaction.total)}, ID: ${transaction.id}`); 

                for (const cartItem of state.cart) {
                    const productToUpdate = state.products.find(p => p.id === cartItem.id);
                    if (productToUpdate) {
                        productToUpdate.stock -= cartItem.quantity;
                        await putItem(STORE_PRODUCTS, productToUpdate);
                    }
                }

                state.cart = [];
                state.discountPercent = 0;
                document.getElementById('discountPercent').value = 0;
                document.getElementById('paymentAmount').value = '';

                await loadProducts(); 
                renderCart();
                updateTotals();

                renderReceiptPreview(transaction);

            } catch (error) {
                console.error('Transaction failed:', error);
                showMessageModal('Kesalahan Transaksi', 'Gagal memproses transaksi. Silakan coba lagi.');
            }
        }

        // --- 7. Logic Manajemen Produk (Modal) ---

        function showProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('productModalTitle');
            const deleteButton = document.getElementById('productDeleteButton');

            form.reset();
            document.getElementById('productId').value = '';
            deleteButton.classList.add('hidden');

            if (productId) {
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    title.textContent = 'Edit Produk: ' + product.name;
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    deleteButton.classList.remove('hidden');
                }
            } else {
                title.textContent = 'Tambah Produk Baru';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function editProduct(productId) {
            showProductModal(productId);
        }

        function hideProductModal() {
            document.getElementById('productModal').classList.remove('flex');
            document.getElementById('productModal').classList.add('hidden');
        }

        async function saveProduct(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('productId').value) || Date.now();
            const name = document.getElementById('productName').value.trim();
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            const stock = parseInt(document.getElementById('productStock').value) || 0;

            if (name === "" || price <= 0 || stock < 0) {
                showMessageModal('Input Tidak Valid', 'Nama, Harga (>0), dan Stok (>=0) harus diisi dengan benar.');
                return;
            }

            const newProduct = { id, name, price, stock };

            try {
                await putItem(STORE_PRODUCTS, newProduct);
                hideProductModal();
                await loadProducts(); 
                showMessageModal('Berhasil', `Produk ${name} telah disimpan.`, 'text-green-600');
                
                const logAction = document.getElementById('productId').value ? 'diperbarui' : 'ditambahkan';
                await logActivity('PRODUCT_MANAGE', `Produk '${name}' ${logAction}. Harga: ${formatRupiah(price)}, Stok: ${stock}.`); 

            } catch (error) {
                console.error('Failed to save product:', error);
                showMessageModal('Kesalahan Penyimpanan', 'Gagal menyimpan produk ke database.');
            }
        }

        async function deleteProduct() {
            const id = parseInt(document.getElementById('productId').value);
            const name = document.getElementById('productName').value;
        
            if (!id) return;
        
            // 1. KUNCI PERBAIKAN: Menyembunyikan ProductModal segera setelah tombol 'Hapus' diklik
            hideProductModal(); 
        
            const confirmed = await showConfirmModal('Hapus Produk', `Apakah Anda yakin ingin menghapus produk "${name}"? Tindakan ini tidak dapat dibatalkan.`);
            
            if (!confirmed) {
                // Jika pengguna membatalkan konfirmasi, kembalikan modal produk
                showProductModal(id); 
                return;
            }
        
            try {
                // Hapus baris hideProductModal() yang lama di sini
                await deleteItem(STORE_PRODUCTS, id); 
                await loadProducts();
                showMessageModal('Berhasil Dihapus', `Produk ${name} telah dihapus.`, 'text-green-600');
                await logActivity('PRODUCT_MANAGE', `Produk '${name}' (ID: ${id}) dihapus.`); 
            } catch (error) {
                console.error('Failed to delete product:', error);
                showMessageModal('Kesalahan Penghapusan', 'Gagal menghapus produk dari database.');
            }
        }

        // --- 8. Logic Riwayat Transaksi (Tab) ---

        function clearHistoryFilters() {
            document.getElementById('historySearch').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            renderHistoryView();
        }

        async function confirmDeleteTransaction(transactionId) { 
            const confirmed = await showConfirmModal('Hapus Transaksi', `Apakah Anda yakin ingin menghapus Transaksi #${transactionId}? Tindakan ini tidak dapat dibatalkan.`);
            if (!confirmed) return;
            
            const pin = await showPinModal('Otentikasi PIN', `Masukkan PIN untuk menghapus Transaksi #${transactionId}:`);
            
            if (pin === null || pin !== '4567') {
                showMessageModal('PIN Salah', 'Penghapusan transaksi dibatalkan.', 'text-red-600');
                return;
            }
            
            try {
                const transactionToDelete = await getOne(STORE_TRANSACTIONS, transactionId);
                if (transactionToDelete && transactionToDelete.items) {
                    for (const item of transactionToDelete.items) {
                        const productToUpdate = state.products.find(p => p.id === item.id);
                        if (productToUpdate) {
                            productToUpdate.stock += item.quantity; 
                            await putItem(STORE_PRODUCTS, productToUpdate);
                        }
                    }
                    await loadProducts(); 
                }


                await deleteItem(STORE_TRANSACTIONS, transactionId);
                await logActivity('TRANSACTION_DELETE', `Transaksi ID ${transactionId} dihapus dari riwayat (Stok dikembalikan).`); 
                renderHistoryView();
                showMessageModal('Berhasil Dihapus', `Transaksi #${transactionId} telah dihapus dari riwayat.`, 'text-green-600');
            } catch (error) {
                console.error('Failed to delete transaction:', error);
                showMessageModal('Kesalahan Penghapusan', 'Gagal menghapus transaksi dari database.');
            }
        }

        async function renderHistoryView() {
            const container = document.getElementById('historyList');
            container.innerHTML = `<p class="text-center text-gray-500" id="loadingHistory">Memuat riwayat...</p>`;

            try {
                let transactions = await getAll(STORE_TRANSACTIONS);
                
                const searchTerm = document.getElementById('historySearch').value.toLowerCase();
                const startDateStr = document.getElementById('startDateFilter').value;
                const endDateStr = document.getElementById('endDateFilter').value;

                transactions = transactions.filter(t => {
                    const matchesSearch = searchTerm === '' ||
                                        t.id.toString().includes(searchTerm) ||
                                        t.items.some(item => item.name.toLowerCase().includes(searchTerm));

                    const transactionDate = new Date(t.timestamp);
                    let matchesDate = true;

                    if (startDateStr) {
                        const startDate = new Date(startDateStr);
                        startDate.setHours(0, 0, 0, 0); 
                        if (transactionDate < startDate) {
                            matchesDate = false;
                        }
                    }

                    if (endDateStr) {
                        const endDate = new Date(endDateStr);
                        endDate.setHours(23, 59, 59, 999); 
                        if (transactionDate > endDate) {
                            matchesDate = false;
                        }
                    }

                    return matchesSearch && matchesDate;
                });
                
                // 1. Hitung Total Pendapatan Bersih (Total DPP) dari transaksi yang sudah difilter
                let totalDpp = 0;
                transactions.forEach(t => {
                    // Pastikan t.dpp ada, jika tidak, gunakan 0
                    totalDpp += t.dpp || 0; 
                });
                
                // 2. Tampilkan Total Pendapatan Bersih dalam kotak informasi
                const summaryBox = document.createElement('div');
                summaryBox.className = 'p-5 mb-4 rounded-xl bg-indigo-50 border-2 border-indigo-200 shadow-md';
                summaryBox.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-indigo-700">üìà Total Pendapatan Bersih (DPP)</h3>
                        <span class="text-2xl font-bold text-indigo-900">${formatRupiah(totalDpp)}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Dihitung dari ${transactions.length} transaksi yang ditampilkan, sebelum PPN dan setelah diskon. Ini adalah **Dasar Pengenaan Pajak (DPP)**.</p>
                `;
                
                container.innerHTML = ''; // Hapus pesan "Memuat riwayat..."
                container.appendChild(summaryBox);
                

                if (transactions.length === 0) {
                    container.innerHTML += `<p class="text-center text-gray-500 py-10">Tidak ada riwayat transaksi yang cocok dengan filter.</p>`;
                    return;
                }

                transactions.sort((a, b) => b.id - a.id);

                transactions.forEach(t => {
                    t.dpp = t.dpp || 0;
                    t.tax = t.tax || 0;
                    t.taxPercent = t.taxPercent || 0;
                    
                    const date = new Date(t.timestamp).toLocaleString('id-ID', {
                        day: '2-digit', month: 'short', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const itemsList = t.items.map(item => `
                        <li class="text-sm text-gray-600">${item.name} (${item.quantity}x) - ${formatRupiah(item.price * item.quantity)}</li>
                    `).join('');
                    
                    const subtotalAfterDiscount = t.subtotal * (1 - (t.discountPercent / 100));
                    const discountAmount = t.subtotal - subtotalAfterDiscount;


                    let taxLinesHistory = '';
                    if (t.taxPercent > 0) {
                        taxLinesHistory = `
                            <p class="text-xs text-gray-600 pt-1">DPP: <span class="float-right">${formatRupiah(t.dpp)}</span></p>
                            <p class="text-xs text-gray-600">PPN (${t.taxPercent}%): <span class="float-right">${formatRupiah(t.tax)}</span></p>
                        `;
                    }

                    const transactionJson = JSON.stringify(t).replace(/"/g, '&quot;'); 

                    const historyItem = document.createElement('div');
                    historyItem.className = 'border p-4 rounded-lg bg-white shadow-sm hover:shadow-md transition duration-150';
                    historyItem.innerHTML = `
                        <div class="flex justify-between items-center border-b pb-2 mb-2 flex-wrap">
                            <h4 class="font-bold text-lg text-indigo-700">Transaksi #${t.id}</h4>
                            <div class="flex items-center space-x-3">
                                <button onclick="renderReceiptPreview(${transactionJson})" class="text-sm text-blue-500 hover:text-blue-700 font-medium">Pratinjau Struk</button>
                                <button onclick="confirmDeleteTransaction(${t.id})" class="text-sm text-red-500 hover:text-red-700 font-medium">Hapus</button> </div>
                        </div>
                        <div class="text-sm text-gray-500 mb-2">Tanggal: ${date}</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="col-span-2">
                                <p class="font-medium text-gray-700">Detail Item:</p>
                                <ul class="list-disc pl-5 space-y-1">${itemsList}</ul>
                            </div>
                            <div class="space-y-1 text-sm md:text-base">
                                <p>Subtotal : <span class="float-right">${formatRupiah(t.subtotal)}</span></p>
                                <p>Diskon (${t.discountPercent}%): <span class="float-right text-red-500">-${formatRupiah(Math.round(discountAmount))}</span></p>
                                ${taxLinesHistory} 
                                <p class="font-bold text-xl border-t pt-2">Total: <span class="float-right text-green-700">${formatRupiah(t.total)}</span></p>
                                <p>Dibayar: <span class="float-right">${formatRupiah(t.payment)}</span></p>
                                <p class="font-bold">Kembalian: <span class="float-right">${formatRupiah(t.change)}</span></p>
                            </div>
                        </div>
                    `;
                    container.appendChild(historyItem);
                });

            } catch (error) {
                console.error('Failed to load history:', error);
                container.innerHTML = `<p class="text-center text-red-500 py-10">Gagal memuat riwayat transaksi.</p>`;
            }
        }
        
        // --- 9. Logic Pratinjau Struk & Cetak ---

        function renderReceiptPreview(transaction) {
            const date = new Date(transaction.timestamp).toLocaleString('id-ID', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            const header = state.settings.receiptHeader.split('\n').map(line => `<div style="text-align: center;">${line}</div>`).join('');
            const footer = state.settings.receiptFooter.split('\n').map(line => `<div style="text-align: center;">${line}</div>`).join('');
            
            let itemsHtml = '';
            transaction.items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                itemsHtml += `<div style="display: flex; justify-content: space-between;"><span>${item.name}</span><span>${formatRupiah(itemTotal)}</span></div>`;
                itemsHtml += `<div style="text-align: left; margin-bottom: 2px; padding-left: 10px;">${item.quantity} x ${formatRupiah(item.price)}</div>`;
            });
            
            // Perhitungan Diskon
            const subtotalAfterDiscount = transaction.dpp + transaction.tax; 
            const discountAmount = transaction.subtotal - subtotalAfterDiscount;
            
            let discountLineHtml = '';
            if (discountAmount > 0) {
                 discountLineHtml = `<div style="display: flex; justify-content: space-between;"><span>Diskon (${transaction.discountPercent}%):</span><span>-${formatRupiah(Math.round(discountAmount))}</span></div>`;
            }

            const cashierNameLine = state.settings.cashierName && state.settings.cashierName.trim() !== ''
                                    ? `<div>Kasir: ${state.settings.cashierName}</div>` 
                                    : ''; 

            let taxLinesHtml = '';
            if (transaction.taxPercent > 0) {
                taxLinesHtml = `
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;"><span>DPP:</span><span>${formatRupiah(transaction.dpp)}</span></div>
                    <div style="display: flex; justify-content: space-between;"><span>PPN (${transaction.taxPercent}%):</span><span>${formatRupiah(transaction.tax)}</span></div>
                `;
            }

            const htmlContent = `
                <div class="receipt-print-area">
                    <div style="margin-bottom: 10px;">
                        ${header}
                    </div>
                    <div style="border-top: 1px dashed #000; padding-top: 5px; margin-bottom: 5px;">
                        ${cashierNameLine}
                        <div>Tanggal: ${date}</div>
                        <div>ID Transaksi: ${transaction.id}</div>
                    </div>
                    
                    <div style="border-top: 1px dashed #000; padding: 5px 0; margin-bottom: 5px;">
                        ${itemsHtml}
                    </div>

                    <div style="border-top: 1px dashed #000; padding-top: 5px; margin-bottom: 5px;">
                        <div style="display: flex; justify-content: space-between;"><span>Subtotal :</span><span>${formatRupiah(transaction.subtotal)}</span></div>
                        ${discountLineHtml}
                        ${taxLinesHtml} 
                        <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #000; padding-top: 3px;"><span>TOTAL:</span><span>${formatRupiah(transaction.total)}</span></div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;"><span>Bayar:</span><span>${formatRupiah(transaction.payment)}</span></div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold;"><span>Kembalian:</span><span>${formatRupiah(transaction.change)}</span></div>
                    </div>

                    <div style="border-top: 1px dashed #000; padding-top: 10px;">
                        ${footer}
                    </div>
                </div>
            `;
            
            document.getElementById('receiptPrintArea').innerHTML = htmlContent;
            document.getElementById('receiptModal').classList.remove('hidden');
            document.getElementById('receiptModal').classList.add('flex');
            
            showMessageModal('Transaksi Berhasil!', 
                `Total: ${formatRupiah(transaction.total)}. Lihat struk di pratinjau.`, 
                'text-green-600'
            );
        }

        function hideReceiptModal() {
            document.getElementById('receiptModal').classList.remove('flex');
            document.getElementById('receiptModal').classList.add('hidden');
            hideMessageModal(); 
        }

        function printReceipt() {
            const printContent = document.getElementById('receiptPrintArea').innerHTML;
            const printWindow = window.open('', '', 'width=400,height=600');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Cetak Struk</title>
                    <style>
                        @page {
                            margin: 0;
                            size: auto;
                        }
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                                width: 58mm; 
                                font-family: 'Courier New', monospace !important;
                                font-size: 10px;
                                line-height: 1.1;
                            }
                            .receipt-print-area {
                                width: 100% !important; 
                                margin: 0 !important;
                                padding: 5px !important; 
                            }
                            .receipt-print-area div {
                                display: block !important;
                                word-wrap: break-word; 
                                white-space: normal;
                            }
                            .receipt-print-area div[style*="display: flex"] {
                                display: flex !important;
                                justify-content: space-between !important;
                                align-items: flex-start;
                                width: 100%;
                            }
                            .receipt-print-area div[style*="padding-left: 10px"] {
                                 padding-left: 5px !important;
                            }
                            .receipt-print-area div[style*="border-top: 1px solid #000"] {
                                border-top: 1px dashed #000 !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }


        // --- 10. Logic Pengaturan (Tab) ---

        function loadSettingsToForm() {
            document.getElementById('receiptHeader').value = state.settings.receiptHeader;
            document.getElementById('receiptFooter').value = state.settings.receiptFooter;
            document.getElementById('taxPercentInput').value = state.settings.taxPercent || 0;
            document.getElementById('cashierNameInput').value = state.settings.cashierName || ''; 
            // BARU: Muat link konsolidasi ke form
            loadTransactionSyncLink(); 
        }

        async function saveSettings() {
            const header = document.getElementById('receiptHeader').value.trim();
            const footer = document.getElementById('receiptFooter').value.trim();
            const taxPercent = parseInt(document.getElementById('taxPercentInput').value) || 0;
            const cashierName = document.getElementById('cashierNameInput').value.trim(); 

            state.settings.receiptHeader = header;
            state.settings.receiptFooter = footer;
            state.settings.taxPercent = taxPercent;
            state.settings.cashierName = cashierName;
            
            const settingsObject = { key: 'receiptConfig', value: state.settings };

            try {
                await putItem(STORE_SETTINGS, settingsObject);
                state.taxPercent = taxPercent; 
                updateTotals(); 
                showMessageModal('Berhasil', 'Pengaturan struk, pajak, dan nama kasir telah disimpan.', 'text-green-600');
                await logActivity('SETTINGS_SAVE', `Pengaturan Struk & Pajak (${taxPercent}%) disimpan.`); 
            } catch (error) {
                console.error('Failed to save settings:', error);
                showMessageModal('Kesalahan', 'Gagal menyimpan pengaturan.', 'text-red-600');
            }
        }
        
        async function exportActivityLogs() { 
            try {
                const logs = await getAll(STORE_ACTIVITY_LOGS);

                const exportObject = {
                    dataType: "ActivityLogs",
                    timestamp: new Date().toISOString(),
                    logs: logs
                };

                const dataStr = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `pos_activity_logs_${new Date().toISOString().slice(0, 10)}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessageModal('Ekspor Log Berhasil', 'Log aktivitas berhasil diekspor sebagai file JSON.', 'text-green-600');

            } catch (error) {
                console.error('Export logs failed:', error);
                showMessageModal('Kesalahan Ekspor', 'Gagal mengekspor log aktivitas.', 'text-red-600');
            }
        }
        
        async function showClearLogsConfirm() { 
            const confirmed = await showConfirmModal('Hapus Semua Log', 'Apakah Anda yakin ingin MENGHAPUS SEMUA Log Aktivitas? Tindakan ini tidak dapat dibatalkan.');
            if (!confirmed) return;
            
            const pin = await showPinModal('Otentikasi PIN', 'Masukkan PIN untuk menghapus semua log:');
            
            if (pin === null || pin !== '4567') {
                showMessageModal('PIN Salah', 'Penghapusan log dibatalkan.', 'text-red-600');
                return;
            }
            
            try {
                await clearStore(STORE_ACTIVITY_LOGS);
                showMessageModal('Berhasil Dihapus', 'Semua log aktivitas telah berhasil dihapus.', 'text-green-600');
            } catch (error) {
                console.error('Clear logs failed:', error);
                showMessageModal('Kesalahan', 'Gagal menghapus log aktivitas.', 'text-red-600');
            }
        }
        
        // --- 11. Logic Export/Import Data ---

        async function exportData() {
            try {
                const products = await getAll(STORE_PRODUCTS);
                const transactions = await getAll(STORE_TRANSACTIONS);
                const settings = await getAll(STORE_SETTINGS);

                const exportObject = {
                    version: DB_VERSION,
                    timestamp: new Date().toISOString(),
                    products: products,
                    transactions: transactions,
                    settings: settings
                };

                const dataStr = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                
                // MODIFIKASI: Nama file statis untuk Version Control Dropbox
                link.download = `pos_sync_data.json`; 
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessageModal('Ekspor Berhasil', 'Data berhasil diunduh sebagai file **pos_sync_data.json**. Harap unggah file ini secara manual ke Dropbox Anda.', 'text-green-600');
                await logActivity('EXPORT_MANUAL', 'Data diekspor secara manual untuk backup.');

            } catch (error) {
                console.error('Export failed:', error);
                showMessageModal('Kesalahan Ekspor', 'Gagal mengekspor data.', 'text-red-600');
            }
        }
        
        // Kunci: Fungsi impor yang lebih modular untuk digunakan oleh importData dan syncFromDropbox
        async function processImport(importedData) {
             if (!importedData.products || !importedData.transactions || !importedData.settings) {
                throw new Error("File JSON tidak memiliki struktur yang benar (membutuhkan products, transactions, settings).");
             }
             
             await clearAllData();

             const stores = [
                { name: STORE_PRODUCTS, data: importedData.products },
                { name: STORE_TRANSACTIONS, data: importedData.transactions },
                { name: STORE_SETTINGS, data: importedData.settings }
             ];

             if (importedData.activityLogs) {
                 stores.push({ name: STORE_ACTIVITY_LOGS, data: importedData.activityLogs });
             }

             for (const store of stores) {
                 for (const item of store.data) {
                     await putItem(store.name, item);
                 }
             }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const confirmed = await showConfirmModal('Konfirmasi Impor', 'Data yang ada (Produk, Transaksi, Pengaturan) akan DITIMPA. Apakah Anda yakin ingin melanjutkan?');
            if (!confirmed) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    await processImport(importedData);
                    
                    await loadSettings();
                    await loadProducts();
                    renderCart();
                    updateTotals();
                    
                    switchTab('posView'); 
                    await logActivity('IMPORT_MANUAL', 'Data berhasil diimpor dari file JSON lokal.');

                    showMessageModal('Impor Berhasil', 'Data berhasil diimpor dan aplikasi dimuat ulang.', 'text-green-600');

                } catch (error) {
                    console.error('Import failed:', error);
                    showMessageModal('Kesalahan Impor', 'Gagal memproses file impor: ' + error.message, 'text-red-600');
                }
            };
            reader.readAsText(file);
        }

        // --- 12. Logic Sinkronisasi Dropbox Baru (Dikonversi Otomatis) ---

        /**
         * Mengkonversi Shared Link Dropbox ke format Unduhan Langsung (dl.dropboxusercontent.com).
         * Ini mengatasi masalah CORS/Izin yang sering terjadi saat menggunakan fetch().
         */
        function normalizeDropboxLink(link) {
            if (!link) return '';
            
            // 1. Ganti domain dari www.dropbox.com menjadi dl.dropboxusercontent.com
            // Menggunakan regex untuk menangani berbagai varian link
            let normalized = link.replace(
                /^https?:\/\/(www\.)?dropbox\.com\//i, 
                'https://dl.dropboxusercontent.com/'
            );
            
            // 2. Pastikan parameter dl=1 ada, atau tambahkan jika tidak ada.
            // Hapus dl=0 atau dl=1 yang sudah ada
            normalized = normalized.replace(/(&|\?)dl=\d+/i, '');

            // Tambahkan dl=1 sebagai parameter terakhir, menggunakan '?' jika belum ada parameter
            // atau '&' jika sudah ada parameter lain
            normalized += (normalized.includes('?') ? '&' : '?') + 'dl=1';
            
            return normalized;
        }

        function loadSyncLink() {
            const link = localStorage.getItem(DB_LINK_STORAGE_KEY) || '';
            const linkInput = document.getElementById('dropboxSyncLink');
            if (linkInput) linkInput.value = link;
            return link;
        }

        function saveSyncLink() {
            const linkInput = document.getElementById('dropboxSyncLink');
            const rawLink = linkInput.value.trim();
            
            if (rawLink) {
                // --- MODIFIKASI INTI ---
                const normalizedLink = normalizeDropboxLink(rawLink);
                // Tampilkan link yang sudah dinormalisasi di input sebagai feedback
                linkInput.value = normalizedLink;
                localStorage.setItem(DB_LINK_STORAGE_KEY, normalizedLink);
                
                // Peringatan link yang dikonversi
                showMessageModal('Berhasil Dikonversi & Disimpan', 
                    'Shared Link Dropbox berhasil dikonversi ke format Unduhan Langsung (`dl.dropboxusercontent.com`) dan disimpan. Link siap digunakan untuk sinkronisasi.', 
                    'text-green-600'
                );
            } else {
                localStorage.removeItem(DB_LINK_STORAGE_KEY);
                showMessageModal('Peringatan', 'Shared Link Dropbox dikosongkan.', 'text-orange-500');
            }
        }

        async function syncFromDropbox() {
            const syncUrl = loadSyncLink();
            
            // Periksa apakah link sudah dinormalisasi ke domain yang benar
            if (!syncUrl || !syncUrl.includes('dl.dropboxusercontent.com')) { 
                 showMessageModal('Gagal Sinkronisasi', 'Shared Link Dropbox belum disetel atau formatnya tidak valid. Harap masukkan link di Pengaturan dan tekan "Simpan Link" terlebih dahulu.', 'text-red-600');
                 return;
            }

            const confirmed = await showConfirmModal('Sinkronisasi Cloud', 'Sinkronisasi akan MENGHAPUS SEMUA DATA LOKAL (Produk, Transaksi, Pengaturan) dan memuat data dari Link Dropbox yang disimpan. Lanjutkan?');
            if (!confirmed) return;

            // Tampilkan pesan loading saat proses unduh
            showMessageModal('Mengunduh Data...', 'Mencoba mengunduh file backup dari Dropbox. Mohon tunggu.', 'text-blue-500', 0); 
            
            try {
                // Penting: Gunakan { cache: 'no-store' } untuk memastikan browser mengambil file terbaru dari Dropbox
                const response = await fetch(syncUrl, { cache: 'no-store' }); 
                
                if (!response.ok) {
                    throw new Error(`Gagal mengambil file: ${response.status} ${response.statusText}. Mungkin file tidak ditemukan, izin salah, atau link kadaluarsa.`);
                }
                
                const fileContent = await response.text();
                const importedData = JSON.parse(fileContent);

                // 1. Validasi Data
                if (!importedData.products || !importedData.transactions || !importedData.settings) {
                    throw new Error("Struktur file backup tidak valid (membutuhkan products, transactions, settings).");
                }
                
                // 2. Tunda proses impor, tampilkan modal konfirmasi kedua
                hideMessageModal(); // Sembunyikan pesan 'Mengunduh Data...'
                
                // Panggil modal konfirmasi kedua
                showSyncConfirmModal(importedData);

            } catch (error) {
                console.error("Kesalahan Sinkronisasi Dropbox:", error);
                hideMessageModal();
                showMessageModal('Gagal Unduh', `Kesalahan saat memuat data dari link. Detail: ${error.message}`, 'text-red-600');
            }
        }

        // FUNGSI BARU: Untuk menampilkan modal konfirmasi setelah file berhasil diunduh
        function showSyncConfirmModal(importedData) {
            const modal = document.getElementById('syncConfirmModal');
            const importButton = document.getElementById('syncConfirmButton');

            // Simpan data sebagai atribut data pada tombol konfirmasi agar bisa diakses saat diklik
            importButton.dataset.importedData = JSON.stringify(importedData);
            
            // Tampilkan data timestamp file yang didownload
            const timestamp = importedData.timestamp ? new Date(importedData.timestamp).toLocaleString('id-ID') : 'Tidak Diketahui';
            document.getElementById('syncConfirmTimestamp').textContent = timestamp;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // FUNGSI BARU: Untuk menjalankan proses impor sebenarnya
        async function performCloudImport(dataJsonString) {
            document.getElementById('syncConfirmModal').classList.remove('flex');
            document.getElementById('syncConfirmModal').classList.add('hidden');
            
            // Tampilkan pesan loading saat proses impor
            showMessageModal('Memproses Impor...', 'Sedang menimpa data lokal dan memuat ulang aplikasi. Mohon tunggu.', 'text-blue-500', 0);
            
            try {
                const importedData = JSON.parse(dataJsonString);
                
                // Panggil fungsi inti impor yang sama dengan impor lokal
                await processImport(importedData); 
                
                // Muat ulang tampilan aplikasi setelah impor
                await loadSettings();
                await loadProducts();
                updateTotals();
                renderCart();
                switchTab('posView'); 
                
                showMessageModal('Sinkronisasi Berhasil!', 'Data Produk, Transaksi, dan Pengaturan berhasil dimuat dari Dropbox.', 'text-green-600');
                await logActivity('SYNC_DROPBOX', 'Data berhasil disinkronkan dari Dropbox Shared Link.');
                
            } catch (error) {
                console.error("Kesalahan Impor Cloud:", error);
                showMessageModal('Gagal Impor', `Kesalahan saat memproses data: ${error.message}`, 'text-red-600');
            }
        }

        // --- BAGIAN BARU: KONSOLIDASI TRANSAKSI CABANG ---

        function loadTransactionSyncLink() {
            const link = localStorage.getItem(TRANSACTION_LINK_STORAGE_KEY) || '';
            const linkInput = document.getElementById('transactionSyncLink');
            // Menggunakan value untuk textarea
            if (linkInput) linkInput.value = link; 
            return link;
        }

        function saveTransactionSyncLink() {
            const linkInput = document.getElementById('transactionSyncLink');
            const rawLinks = linkInput.value.trim();
            
            if (rawLinks) {
                // Pisahkan semua baris, filter baris kosong, dan normalisasi setiap link
                const linkArray = rawLinks.split('\n')
                    .map(link => link.trim())
                    .filter(link => link.length > 0);
                
                const normalizedLinks = linkArray.map(link => normalizeDropboxLink(link)).join('\n');
                
                // Simpan kembali string yang sudah dinormalisasi ke textarea dan localStorage
                linkInput.value = normalizedLinks;
                localStorage.setItem(TRANSACTION_LINK_STORAGE_KEY, normalizedLinks);
                
                showMessageModal('Berhasil Dikonversi & Disimpan', 
                    `Berhasil menyimpan **${linkArray.length}** Shared Link Riwayat Transaksi yang telah dikonversi ke format Unduhan Langsung.`, 
                    'text-green-600'
                );
            } else {
                localStorage.removeItem(TRANSACTION_LINK_STORAGE_KEY);
                showMessageModal('Peringatan', 'Shared Link Riwayat Transaksi dikosongkan.', 'text-orange-500');
            }
        }

        async function exportTransactionsOnly() {
            try {
                // --- BARU: Ambil log aktivitas ---
                const logs = await getAll(STORE_ACTIVITY_LOGS); 
                // ----------------------------------
                
                const transactions = await getAll(STORE_TRANSACTIONS);

                const exportObject = {
                    dataType: "TransactionsOnly", 
                    timestamp: new Date().toISOString(),
                    transactions: transactions,
                    // --- BARU: Sertakan log aktivitas dalam objek ekspor ---
                    activityLogs: logs
                    // --------------------------------------------------------
                };

                const dataStr = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `pos_transactions_only_${new Date().toISOString().slice(0, 10)}.json`; 
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessageModal('Ekspor Berhasil', 'Riwayat transaksi berhasil diunduh. File ini siap diunggah ke Shared Link Dropbox untuk konsolidasi.', 'text-green-600');
                
                // LOG AKTIVITAS BARU
                await logActivity('EXPORT_TRANSACTIONS_CABANG', 'Riwayat transaksi diekspor untuk konsolidasi.');

            } catch (error) {
                console.error('Export transactions failed:', error);
                showMessageModal('Kesalahan Ekspor', 'Gagal mengekspor riwayat transaksi.', 'text-red-600');
            }
        }

        async function syncTransactionFromDropbox() {
            const rawSyncUrls = loadTransactionSyncLink();
            
            if (!rawSyncUrls) { 
                 showMessageModal('Gagal Sinkronisasi', 'Shared Link Riwayat Transaksi belum disetel. Harap masukkan daftar link di Pengaturan dan tekan "Simpan Link" terlebih dahulu.', 'text-red-600');
                 return;
            }
            
            const syncUrls = rawSyncUrls.split('\n').filter(url => url.includes('dl.dropboxusercontent.com'));
            
            if (syncUrls.length === 0) {
                 showMessageModal('Gagal Sinkronisasi', 'Tidak ada link yang valid dan sudah dinormalisasi ditemukan. Harap periksa input Anda.', 'text-red-600');
                 return;
            }

            const pin = await showPinModal('Otentikasi PIN', `Masukkan PIN untuk Menggabungkan Riwayat Transaksi dari **${syncUrls.length}** Cloud Link:`);
            if (pin === null || pin !== '4567') {
                showMessageModal('PIN Salah', 'Penggabungan transaksi dibatalkan.', 'text-red-600');
                return;
            }

            showMessageModal('Memulai Penggabungan...', `Akan memproses ${syncUrls.length} file riwayat transaksi.`, 'text-blue-500', 0); 
            
            let totalMergedCount = 0;
            const existingTransactions = await getAll(STORE_TRANSACTIONS);
            const existingIds = new Set(existingTransactions.map(t => t.id));

            let totalMergedLogsCount = 0;
            // --- BARU: Ambil semua ID log yang sudah ada ---
            const existingLogs = await getAll(STORE_ACTIVITY_LOGS);
            const existingLogIds = new Set(existingLogs.map(l => l.id));
            // ----------------------------------------------------

            try {
                // LOOP melalui setiap URL
                for (let i = 0; i < syncUrls.length; i++) {
                    const syncUrl = syncUrls[i];
                    const branchName = `Cabang ${i + 1}`; 
                    showMessageModal('Mengunduh Riwayat...', `(${i + 1}/${syncUrls.length}) Mengunduh file dari ${branchName}...`, 'text-blue-500', 0); 

                    // 1. Ambil Data
                    const response = await fetch(syncUrl, { cache: 'no-store' }); 
                    
                    if (!response.ok) {
                        console.warn(`Gagal mengambil file dari ${branchName}: ${response.status} ${response.statusText}. Melewati.`);
                        await logActivity('SYNC_TRANSACTION_ERROR', `Gagal mengambil file dari ${branchName}. Status: ${response.status}`);
                        continue; 
                    }
                    
                    const fileContent = await response.text();
                    const importedData = JSON.parse(fileContent);

                    if (importedData.dataType !== "TransactionsOnly" || !importedData.transactions) {
                        console.warn(`File ${branchName} tidak memiliki struktur transaksi yang benar. Melewati.`);
                        await logActivity('SYNC_TRANSACTION_ERROR', `Struktur file ${branchName} tidak valid.`);
                        continue;
                    }
                    
                    // 2. Gabungkan Transaksi
                    const transactionsToMerge = importedData.transactions;
                    let mergedCount = 0;

                    for (const transaction of transactionsToMerge) {
                        if (!existingIds.has(transaction.id)) {
                            await putItem(STORE_TRANSACTIONS, transaction); 
                            existingIds.add(transaction.id); 
                            mergedCount++;
                        }
                    }
                    totalMergedCount += mergedCount;
                    
                    // --- BARU: Logika Penggabungan Log Aktivitas ---
                    if (importedData.activityLogs && importedData.activityLogs.length > 0) {
                        let mergedLogsCount = 0;
                        for (const log of importedData.activityLogs) {
                            if (!existingLogIds.has(log.id)) {
                                await putItem(STORE_ACTIVITY_LOGS, log);
                                existingLogIds.add(log.id); 
                                mergedLogsCount++;
                            }
                        }
                        totalMergedLogsCount += mergedLogsCount;
                        await logActivity('SYNC_LOG_MERGE', `Menggabungkan ${mergedLogsCount} log aktivitas baru dari ${branchName}.`);
                    }
                    // ----------------------------------------------------

                    // LOG KEBERHASILAN PENGGABUNGAN PER CABANG
                    await logActivity('SYNC_TRANSACTION_MERGE', `Menggabungkan ${mergedCount} transaksi baru dari ${branchName}.`);
                } // END LOOP

                hideMessageModal();
                renderHistoryView();
                
                // LOG RINGKASAN PROSES DAN UPDATE MESSAGE MODAL
                await logActivity('SYNC_TRANSACTION_SUMMARY', 
                    `Berhasil menggabungkan total ${totalMergedCount} transaksi dan ${totalMergedLogsCount} log aktivitas dari ${syncUrls.length} link cabang.`
                );

                showMessageModal('Penggabungan Cloud Berhasil!', 
                    `Berhasil menggabungkan **${totalMergedCount}** transaksi baru dan **${totalMergedLogsCount}** log aktivitas baru dari total **${syncUrls.length}** file cabang yang diproses.`, 
                    'text-green-600'
                );

            } catch (error) {
                console.error("Kesalahan Sinkronisasi Dropbox Transaksi Global:", error);
                hideMessageModal();
                showMessageModal('Gagal Gabungkan', `Kesalahan saat memproses penggabungan: ${error.message}`, 'text-red-600');
            }
        }


        // --- 13. Inisialisasi Aplikasi ---

        window.onload = async () => {
            if (!window.indexedDB) {
                showMessageModal('Error Fatal', 'Browser Anda tidak mendukung IndexedDB. Aplikasi tidak dapat berjalan.', 'text-red-700');
                return;
            }

            setupConfirmListeners();
            setupPinModalListeners(); 
            await initDB();
            
            // Muat Link Sinkronisasi dan pengaturan lainnya
            loadSyncLink();
            loadTransactionSyncLink(); // Muat link transaksi
            await loadSettings();
            await loadProducts();
            
            renderCart();
            updateTotals();
            switchTab('posView'); 

            document.getElementById('discountPercent').addEventListener('input', updateTotals);
            document.getElementById('paymentAmount').addEventListener('input', calculateChange);
            document.getElementById('taxPercentInput').addEventListener('input', () => {
                state.settings.taxPercent = parseInt(document.getElementById('taxPercentInput').value) || 0;
                updateTotals(); 
            });
            document.getElementById('cashierNameInput').addEventListener('input', () => {
                state.settings.cashierName = document.getElementById('cashierNameInput').value.trim();
            });
            
            // Listener untuk tombol Dropbox
            document.getElementById('syncFromDropboxButton').addEventListener('click', syncFromDropbox);
            
            // MODIFIKASI: Mengubah pesan konfirmasi download
            document.getElementById('downloadDataButton').addEventListener('click', async () => {
                await exportData();
                showMessageModal('Perhatian Upload', 'File JSON bernama **pos_sync_data.json** telah diunduh ke perangkat Anda. Harap unggah file ini secara **manual** ke Shared Folder Dropbox Anda.', 'text-orange-500');
            });
        };
    </script>
</body>
</html>
